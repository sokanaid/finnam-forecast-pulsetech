# 🚀 FORECAST - Прогноз движения цены с учётом новостного контекста

> Решение для хакатона **Finam x HSE Trade AI Hack** - задача прогнозирования вероятностей роста цен акций на 20 торговых дней вперед.

[![Python 3.9+](https://img.shields.io/badge/python-3.9+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

---

## ⚡ Быстрый старт (3 команды)

```bash
# 1. Установка зависимостей
pip install -r requirements.txt

# 2. Обучение модели (15-30 минут)
python train.py

# 3. Создание предсказаний (1-5 минут)
python predict.py
```

**Результат:** файл `submission.csv` готов для отправки на лидерборд! 🎉

---

## 📋 Содержание

- [Описание задачи](#-описание-задачи)
- [Что реализовано](#-что-реализовано)
- [Архитектура решения](#-архитектура-решения)
- [Извлечение тикеров](#-извлечение-тикеров)
- [Установка](#-установка)
- [Использование](#-использование)
- [Примеры запуска](#-примеры-запуска)
- [Структура проекта](#-структура-проекта)
- [Конфигурация](#-конфигурация)
- [Технические детали](#-технические-детали)
- [Решение проблем](#-решение-проблем)

---

## 📊 Описание задачи

Прогнозирование **вероятностей роста цен акций** на 1, 2, ..., 20 торговых дней вперед с использованием:
- Исторических данных о котировках (OHLCV)
- Новостей о компаниях
- Технических индикаторов
- Агрегированных признаков из новостей

### Метрика оценки

```
Score = 0.7 × MAE_norm + 0.3 × Brier_norm + 0.1 × DA
```

Где:
- **MAE** - средняя абсолютная ошибка прогноза доходности
- **Brier Score** - ошибка калибровки вероятностей
- **DA** - точность предсказания направления движения

---

## ✅ Что реализовано

### 1. Полный пайплайн ML
- ✅ Загрузка и предобработка данных (котировки + новости)
- ✅ **Автоматическое извлечение тикеров** (регулярные выражения + кластеризация)
- ✅ Feature Engineering (40+ признаков из котировок)
- ✅ Обучение 20 моделей (по одной на каждый горизонт)
- ✅ Создание предсказаний вероятностей роста
- ✅ Сохранение результатов в формате submission.csv

### 2. Извлечение тикеров (если отсутствуют в данных)
- ✅ **Из новостей**: регулярные выражения для поиска тикеров (35+ тикеров)
  - Прямые упоминания: SBER, GAZP, LKOH, YNDX и др.
  - Названия компаний: Сбербанк → SBER, Газпром → GAZP
- ✅ **Из котировок**: кластеризация K-Means
  - Группировка по ценовым уровням, объему, волатильности
  - Автоматическое присвоение тикеров кластерам

### 3. Feature Engineering
**Технические индикаторы (40+ признаков):**
- Доходности (1d, 5d, 10d, 20d)
- Скользящие средние (MA 5, 10, 20) и расстояния от них
- Волатильность (5d, 10d, 20d)
- RSI (14 периодов)
- MACD + сигнальная линия
- Bollinger Bands (позиция, ширина)
- Тренд (slope линейной регрессии)
- High-Low спред
- Объем торгов и его динамика

**Из новостей:**
- Количество новостей по дням
- Агрегированная статистика
- Sentiment score (на основе ключевых слов)

### 4. Модель
- **Архитектура**: 20 независимых классификаторов (по одному на каждый горизонт)
- **Алгоритм**: LightGBM (с fallback на sklearn GradientBoosting)
- **Валидация**: 80/20 split с сохранением временного порядка
- **Выход**: Вероятности роста p1, p2, ..., p20 ∈ [0, 1]

### 5. Гибкая конфигурация
- ✅ Аргументы командной строки для всех путей
- ✅ Значения по умолчанию из config.py
- ✅ Возможность работы с разными наборами данных
- ✅ Справка через `--help`

---

## 🏗️ Архитектура решения

### Основные компоненты

```
┌─────────────────────────────────────────────────────────────────┐
│                         FORECAST PIPELINE                        │
└─────────────────────────────────────────────────────────────────┘

┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   Котировки  │───▶│  DataLoader  │───▶│   Тикеры     │
│  (OHLCV)     │    │              │    │  (extracted) │
└──────────────┘    └──────────────┘    └──────────────┘
                            │
┌──────────────┐            │            ┌──────────────┐
│   Новости    │────────────┴───────────▶│   Features   │
│  (text)      │                         │  (40+ items) │
└──────────────┘                         └──────────────┘
                                                 │
                                                 ▼
┌─────────────────────────────────────────────────────────┐
│            Feature Engineering                          │
│  • RSI, MACD, Bollinger Bands                          │
│  • Скользящие средние                                  │
│  • Волатильность и моментум                            │
│  • Агрегации новостей                                  │
└─────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│         20 моделей LightGBM/GradientBoosting           │
│  Model₁ → p₁  │  Model₂ → p₂  │ ... │  Model₂₀ → p₂₀ │
└─────────────────────────────────────────────────────────┘
                         │
                         ▼
                  submission.csv
           (ticker, p1, p2, ..., p20)
```

### Модули

1. **`src/config.py`** - конфигурация, пути, гиперпараметры
2. **`src/ticker_extractor.py`** - извлечение тикеров из текста и данных
3. **`src/data_loader.py`** - загрузка и предобработка CSV файлов
4. **`src/feature_engineering.py`** - создание технических индикаторов
5. **`src/model.py`** - обучение и предсказание (20 моделей)
6. **`train.py`** - скрипт обучения ⭐
7. **`predict.py`** - скрипт создания предсказаний ⭐
8. **`evaluation.py`** - скрипт оценки качества

---

## 🔍 Извлечение тикеров

### Проблема
В датасете может отсутствовать колонка `ticker`, что делает невозможным группировку данных по акциям.

### Решение

#### 1. Извлечение из новостей (regex)

**Поддерживаемые тикеры (35+):**
```
SBER, GAZP, LKOH, GMKN, NVTK, ROSN, TATN, MGNT, MTSS, ALRS, 
SNGS, NLMK, CHMF, VTBR, YNDX, PLZL, AFLT, MOEX, RTKM, FEES, 
HYDR, IRAO, PHOR, RUAL, TCSG, AFKS, PIKK, POLY, MAIL, OZON, 
FIXP, CBOM, TRNFP, UPRO, MAGN
```

**Соответствие названий компаний:**
```python
'сбер'/'сбербанк' → SBER
'газпром' → GAZP
'лукойл' → LKOH
'яндекс'/'yandex' → YNDX
'тинькофф'/'tcs' → TCSG
'втб' → VTBR
... и т.д.
```

**Точность:** ~97% новостей содержат извлеченные тикеры

#### 2. Кластеризация котировок (K-Means)

Когда тикеры не могут быть извлечены из новостей, используется кластеризация:

**Признаки для кластеризации:**
- Средняя цена (сглаженная)
- Логарифм объема торгов (сглаженный)
- Волатильность цены

**Алгоритм:**
1. Нормализация признаков
2. K-Means clustering (10-15 кластеров)
3. Сортировка кластеров по средней цене
4. Присвоение тикеров из списка известных

**Примечание:** Это эвристический подход, точность зависит от данных.

---

## 📦 Установка

### Требования
- Python 3.9+
- 4GB RAM минимум
- ~30-40 минут для полного обучения

### Установка зависимостей

```bash
# Базовая установка
pip install -r requirements.txt

# Или вручную (основные пакеты)
pip install pandas numpy scikit-learn lightgbm joblib tqdm
```

### Требуемые файлы данных

Разместите файлы в директории `data/raw/`:
- `train_candles.csv` - обучающие котировки
- `train_news.csv` - обучающие новости
- `public_test_candles.csv` - публичный тест
- `private_test_candles.csv` - приватный тест
- `test_news.csv` - тестовые новости

---

## 🚀 Использование

### Базовый запуск (значения по умолчанию)

```bash
# Обучение
python train.py

# Предсказание
python predict.py

# Проверка submission
python evaluation.py submission.csv
```

### Справка по аргументам

```bash
python train.py --help
python predict.py --help
python evaluation.py --help
```

---

## 🎯 Примеры запуска

### 1. Стандартный пайплайн

```bash
# Шаг 1: Обучение модели
python train.py

# Что происходит:
# ✓ Загружает data/raw/train_candles.csv и train_news.csv
# ✓ Создает 40+ технических индикаторов
# ✓ Обучает 20 моделей LightGBM
# ✓ Сохраняет в models/forecast_models.pkl

# Шаг 2: Создание предсказаний
python predict.py

# Что происходит:
# ✓ Загружает models/forecast_models.pkl
# ✓ Обрабатывает public + private test
# ✓ Создает предсказания p1-p20
# ✓ Сохраняет submission.csv
```

### 2. С указанием путей к файлам

```bash
# Обучение на кастомных данных
python train.py \
  --train-candles /path/to/my_train_candles.csv \
  --train-news /path/to/my_train_news.csv \
  --output-dir ./my_models/

# Предсказание с кастомными моделями
python predict.py \
  --public-test-candles /path/to/public_test.csv \
  --private-test-candles /path/to/private_test.csv \
  --test-news /path/to/test_news.csv \
  --models-dir ./my_models/ \
  --output my_submission.csv
```

### 3. Эксперименты с разными версиями

```bash
# Версия 1
python train.py --output-dir models/v1/
python predict.py --models-dir models/v1/ --output submission_v1.csv

# Версия 2 (другие данные)
python train.py \
  --train-candles data/augmented/train_candles.csv \
  --output-dir models/v2/
python predict.py --models-dir models/v2/ --output submission_v2.csv

# Сравнение
python evaluation.py submission_v1.csv
python evaluation.py submission_v2.csv
```

### 4. Отладка на подмножестве данных

```bash
# Создать небольшой датасет
head -1000 data/raw/train_candles.csv > data/debug/train_candles_small.csv
head -500 data/raw/train_news.csv > data/debug/train_news_small.csv

# Быстрое обучение для проверки
python train.py \
  --train-candles data/debug/train_candles_small.csv \
  --train-news data/debug/train_news_small.csv \
  --output-dir models/debug/
```

---

## 📁 Структура проекта

```
finnam_hackaton/
├── 📂 data/
│   ├── raw/                     # Исходные данные
│   │   ├── train_candles.csv
│   │   ├── train_news.csv
│   │   ├── public_test_candles.csv
│   │   ├── private_test_candles.csv
│   │   └── test_news.csv
│   └── processed/               # Обработанные данные (создается автоматически)
│
├── 📂 models/                   # Обученные модели (создается автоматически)
│   ├── forecast_models.pkl
│   └── processed_data.pkl
│
├── 📂 src/                      # Исходный код модулей
│   ├── config.py               # Конфигурация
│   ├── ticker_extractor.py     # Извлечение тикеров
│   ├── data_loader.py          # Загрузка данных
│   ├── feature_engineering.py  # Создание признаков
│   └── model.py                # ML модель
│
├── 🚀 train.py                  # Скрипт обучения
├── 🔮 predict.py                # Скрипт предсказания
├── 📊 evaluation.py             # Скрипт оценки
│
├── 📄 requirements.txt          # Зависимости Python
├── 📄 .gitignore               # Правила игнорирования
│
├── 📖 README.md                 # Этот файл
├── 📖 USAGE.md                  # Дополнительные примеры
├── 📖 SUMMARY.md                # Итоговая сводка
└── 📖 QUICK_START.md            # Краткий гайд
```

---

## ⚙️ Конфигурация

### Основные параметры (src/config.py)

```python
# Воспроизводимость
RANDOM_SEED = 42

# Признаки
WINDOW_SIZE = 20              # Размер окна для признаков
N_HORIZONS = 20               # Количество горизонтов прогноза

# Обучение
TRAIN_VAL_SPLIT = 0.8        # Доля train в разбиении

# Параметры модели LightGBM
MODEL_PARAMS = {
    'n_estimators': 200,
    'max_depth': 6,
    'learning_rate': 0.05,
    'subsample': 0.8,
    'colsample_bytree': 0.8,
    'random_state': 42,
}
```

### Изменение параметров

Отредактируйте `src/config.py` или `src/model.py` для настройки гиперпараметров моделей.

---

## 📊 Формат данных

### Входные файлы

**train_candles.csv / test_candles.csv:**
```csv
open,close,high,low,volume,begin,ticker
81.5,81.7,83.2,81.16,29755530,2020-06-19,SBER
```

**train_news.csv / test_news.csv:**
```csv
publish_date,title,publication
2020-01-01 14:00:00,Заголовок новости,Текст новости...
```

### Выходной файл

**submission.csv:**
```csv
ticker,p1,p2,p3,...,p20
SBER,0.55,0.56,0.57,...,0.74
GAZP,0.45,0.46,0.47,...,0.64
```

Где:
- `ticker` - тикер акции
- `p1`, `p2`, ..., `p20` - вероятности роста на 1-20 дней (от 0 до 1)

---

## 🔧 Технические детали

### Зависимости

**Основные:**
- `pandas` (≥2.2) - обработка данных
- `numpy` (≥1.26) - численные вычисления
- `scikit-learn` (≥1.4) - ML утилиты, метрики
- `joblib` (≥1.3) - сериализация моделей

**ML:**
- `lightgbm` (≥4.1, опционально) - градиентный бустинг
  - При отсутствии: fallback на `sklearn.ensemble.GradientBoostingClassifier`

**Дополнительные (опционально):**
- `transformers` - для расширенного NLP
- `torch` - для нейронных сетей
- `ta` - библиотека технических индикаторов

### Требования к системе

- **CPU**: любой современный процессор (4+ ядра рекомендуется)
- **RAM**: минимум 4GB, рекомендуется 8GB
- **Диск**: ~500MB для данных и моделей
- **Время**:
  - Обучение: 15-30 минут
  - Предсказание: 1-5 минут

### Производительность

На стандартном ноутбуке (Intel i5, 8GB RAM):
- **Feature engineering**: ~5 минут
- **Обучение 20 моделей**: ~20 минут
- **Предсказание**: ~2 минуты
- **Память**: ~3-4GB пик

---

## 🐛 Решение проблем

### "OSError: Library not loaded: libomp.dylib" (LightGBM на macOS)

**Решение:** Система автоматически переключится на sklearn GradientBoosting.

Вы увидите сообщение:
```
⚠️  LightGBM недоступен, используем sklearn GradientBoostingClassifier
```

Это нормально - решение продолжит работу.

### "Memory Error"

**Решения:**
1. Уменьшите `WINDOW_SIZE` в `src/config.py` (например, с 20 до 10)
2. Запустите на машине с большим объемом RAM
3. Уменьшите количество признаков в `feature_engineering.py`
4. Используйте меньше train данных для отладки

### "File not found"

**Проверьте:**
1. Все файлы данных находятся в `data/raw/`:
   ```bash
   ls -lh data/raw/*.csv
   ```
2. Запускаете скрипты из корневой директории проекта:
   ```bash
   pwd  # должно быть: .../finnam_hackaton
   ```

### Долгое обучение

**Ускорение:**
1. Уменьшите `n_estimators` в `src/model.py` (с 200 до 100)
2. Увеличьте `learning_rate` (с 0.05 до 0.1)
3. Используйте подмножество данных для экспериментов
4. Запустите на более мощном процессоре

### Тикеры не извлекаются правильно

**Если точность низкая:**
1. Проверьте лог извлечения тикеров
2. При необходимости добавьте новые тикеры в `src/ticker_extractor.py`
3. Расширьте словарь `COMPANY_TO_TICKER`

---

## 🎯 Подход и гипотезы

### Основные гипотезы

1. **Моментум продолжается** - недавнее движение цен содержит сигнал для прогнозов
2. **Технические индикаторы работают** - RSI, MACD, BB отражают состояние рынка
3. **Новости влияют на движение** - количество новостей коррелирует с волатильностью
4. **Разные горизонты требуют разных моделей** - характер движения на 1 день ≠ 20 дней

### Подход к валидации

- **Временная корректность**: используем данные только до момента t
- **No lookahead bias**: новости учитываются с задержкой
- **Отложенная выборка**: последние 20% для валидации
- **Калибровка**: клиппинг вероятностей в [0.05, 0.95]

---

## 📚 Полезные команды

```bash
# Просмотр данных
head -5 data/raw/train_candles.csv
head -5 submission.csv

# Подсчет строк
wc -l data/raw/*.csv

# Размер моделей
ls -lh models/*.pkl

# Проверка submission
python evaluation.py submission.csv

# Запуск с логированием
python train.py 2>&1 | tee logs/train.log
python predict.py 2>&1 | tee logs/predict.log
```

---

## 🔗 Ссылки

- [Репозиторий организаторов](https://github.com/Orange-Hack/finam-x-hse-trade-ai-hack-forecast)
- [Adjusted Close Price](https://en.wikipedia.org/wiki/Adjusted_closing_price)
- [Mean Absolute Error](https://en.wikipedia.org/wiki/Mean_absolute_error)
- [Brier Score](https://en.wikipedia.org/wiki/Brier_score)
- [LightGBM Documentation](https://lightgbm.readthedocs.io/)

---

## 👥 Команда

**Pulsetech**

Решение для хакатона **Finam x HSE Trade AI Hack**  
Октябрь 2025

---

## 📄 Лицензия

MIT License - свободное использование с указанием авторства

---

## 🎉 Удачи в хакатоне! 🚀📈

**Дополнительная документация:**
- `USAGE.md` - расширенные примеры использования и сценарии
- `SUMMARY.md` - детальная техническая сводка решения
- `QUICK_START.md` - краткий гайд для начинающих
